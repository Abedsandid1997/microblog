---
- hosts: appservers
  remote_user: "deploy"
  become: yes
  become_method: sudo
  gather_facts: yes
  serial: 1
  vars:
    microblog_container_name: microblog
    microblog_image_prefix: abedsandeed/microblog
    env_file_path: "./.env"
    healthcheck_url: "http://localhost:8000/version"
    microblog_tag: "{{ microblog_tag | default('1.0.0-prod') }}"

  tasks:
    - name: Pull latest Microblog image for this server
      docker_image:
        name: "{{ microblog_image_prefix }}:{{ microblog_tag }}"
        source: pull

    - name: Stop old Microblog container
      docker_container:
        name: "{{ microblog_container_name }}"
        state: stopped
      ignore_errors: yes

    - name: Start new Microblog container with new image
      docker_container:
        name: "{{ microblog_container_name }}"
        image: "{{ microblog_image_prefix }}:{{ microblog_tag }}"
        state: started
        restart_policy: always
        env_file: "{{ env_file_path }}"
        ports:
          - "8000:5000"

    - name: Wait for Microblog to be healthy
      uri:
        url: "{{ healthcheck_url }}"
        method: GET
        status_code: 200
      register: result
      retries: 10
      delay: 5
      until: result.status == 200
      delegate_to: "{{ inventory_hostname }}"

    - name: Verify running Microblog version
      shell: curl -s "{{ healthcheck_url }}"
      register: version_result

    - name: Parse version JSON from curl
      set_fact:
        version_result_dict: "{{ version_result.stdout | from_json }}"

    - name: Set expected version as dict
      set_fact:
        microblog_short_tag_dict:
          version: "{{ microblog_tag | regex_replace('-prod$', '') }}"

    - name: Fail if version mismatch
      fail:
        msg: "Microblog version mismatch! Expected {{ microblog_short_tag_dict }}, got {{ version_result_dict }}"
      when: version_result_dict != microblog_short_tag_dict
